name: Deploy ClawDNA to Solana Devnet

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  # Use Solana 1.18.x for stability (compatible with Anchor 0.29.0)
  SOLANA_VERSION: 1.18.26
  ANCHOR_VERSION: 0.29.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Install Solana CLI
      run: |
        # Download Solana CLI (stable version for Anchor 0.29.0)
        sh -c "$(curl -sSfL https://release.solana.com/v${SOLANA_VERSION}/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        solana --version

    - name: Install Anchor CLI
      run: |
        npm install -g @coral-xyz/anchor-cli@${ANCHOR_VERSION}
        anchor --version

    - name: Setup Solana Wallet
      env:
        SOLANA_KEYPAIR: ${{ secrets.SOLANA_KEYPAIR }}
      run: |
        mkdir -p ~/.config/solana
        echo "$SOLANA_KEYPAIR" > ~/.config/solana/id.json
        solana config set --url devnet
        echo "Wallet address:"
        solana address
        echo "Balance:"
        solana balance

    - name: Build program
      env:
        CARGO_UNSTABLE_NEXT_LOCKFILE_BUMP: true
      run: |
        cd clawdna
        rm -f Cargo.lock
        # Create cargo config to handle lockfile v4
        mkdir -p .cargo
        echo '[unstable]' > .cargo/config.toml
        echo 'next-lockfile-bump = true' >> .cargo/config.toml
        anchor build

    - name: Deploy to Devnet
      run: |
        cd clawdna
        solana program deploy target/deploy/clawdna.so --url devnet 2>&1 | tee deploy.log
        cat deploy.log

    - name: Extract and Save Program ID
      run: |
        cd clawdna
        PROGRAM_ID=$(grep -oE '[1-9A-HJ-NP-Za-km-z]{32,44}' deploy.log | head -1 || cat DEPLOYED_PROGRAM_ID.txt)
        echo "$PROGRAM_ID" > DEPLOYED_PROGRAM_ID.txt
        echo "PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_ENV
        echo "Deployed Program ID: $PROGRAM_ID"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deploy-artifacts
        path: |
          clawdna/target/deploy/clawdna.so
          clawdna/target/idl/clawdna.json
          clawdna/DEPLOYED_PROGRAM_ID.txt

    - name: Show deploy info
      run: |
        echo "========================================"
        echo "âœ… Deploy ClawDNA Complete!"
        echo "========================================"
        echo "Program ID: $PROGRAM_ID"
        echo "Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet"
        echo "========================================"
