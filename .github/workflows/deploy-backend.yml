name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy-koyeb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Koyeb CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/koyeb/koyeb-cli/master/install.sh | sh
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Deploy to Koyeb
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_TOKEN }}
        run: |
          koyeb login --token "$KOYEB_TOKEN"
          
          # Check if service exists
          if koyeb service get clawdna-backend/clawdna-api 2>/dev/null; then
            echo "Service exists, updating..."
            koyeb service update clawdna-backend/clawdna-api \
              --git github.com/NovaAgentOpenclaw/clawdna \
              --git-branch main \
              --ports 8000:http \
              --routes '/api:8000' \
              --env CORS_ORIGINS="https://clawdna.xyz,https://*.vercel.app" \
              --env SOLANA_RPC_URL="https://api.devnet.solana.com"
          else
            echo "Creating new service..."
            koyeb app create clawdna-backend || true
            koyeb service create clawdna-backend/clawdna-api \
              --git github.com/NovaAgentOpenclaw/clawdna \
              --git-branch main \
              --ports 8000:http \
              --routes '/api:8000' \
              --env CORS_ORIGINS="https://clawdna.xyz,https://*.vercel.app" \
              --env SOLANA_RPC_URL="https://api.devnet.solana.com"
          fi
